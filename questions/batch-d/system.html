<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" href="../../Image_fx6.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الاختبار - منظومة الحاسب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: rgba(255, 255, 255, 0.05);
            --border-color: rgba(255, 255, 255, 0.1);
            --text-light: #e0e0e0;
            --primary-neon: linear-gradient(45deg, #a453ff, #54aaff);
            --accent-orange: #ff6b35;
        }
        .day-mode {
            --bg-color: #1b405f;
            --card-bg: rgba(255, 255, 255, 0.7);
            --text-light: #ec6211;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s;
        }
        .quiz-container, .final-form, .result-container {
            display: none;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            margin: 2rem auto;
            max-width: 800px;
            border: 1px solid var(--border-color);
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .question-counter {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-orange);
        }
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: var(--text-light);
            font-weight: 600;
        }
        .options-container {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .option-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
            padding: 1rem;
            border-radius: 12px;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        .option-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            color: var(--text-light);
        }
        .option-btn.selected {
            background: var(--accent-orange);
            color: white;
            transform: scale(1.02);
        }
        .option-btn.correct {
            background: #28a745;
            color: white;
        }
        .option-btn.wrong {
            background: #dc3545;
            color: white;
        }
        .essay-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 1.1rem;
            resize: vertical;
            margin-bottom: 1.5rem;
        }
        .quiz-btns {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        .quiz-btn {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .next-btn, .submit-btn {
            background: var(--accent-orange);
            color: white;
        }
        .next-btn:hover, .submit-btn:hover {
            background: #e05a2a;
        }
        .restart-btn {
            background: #6c757d;
            color: white;
        }
        .back-btn {
            background: #28a745;
            color: white;
        }
        .result-score {
            font-size: 3rem;
            font-weight: 800;
            background: var(--primary-neon);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 1rem 0;
        }
        .result-text {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: var(--text-light);
        }
        .explanation {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            text-align: right;
            border-right: 4px solid var(--accent-orange);
        }
        .explanation h5 {
            color: var(--accent-orange);
            margin-bottom: 0.5rem;
        }
        .final-form input {
            width: 100%;
            padding: 12px;
            margin: 0.5rem 0;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 1.1rem;
        }
        .theme-toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--accent-orange);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
        }
        .back-to-home-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle-btn">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container py-5">
        <div id="quizContainer" class="quiz-container">
            <div class="quiz-header">
                <div class="question-counter" id="questionCounter">السؤال 1 من 2</div>
                <button class="btn btn-outline-light" onclick="exitQuiz()">
                    <i class="fas fa-times"></i> إنهاء
                </button>
            </div>
            <div class="question-text" id="questionText">نص السؤال هنا...</div>
            <div class="options-container" id="optionsContainer"></div>
            <div class="quiz-btns">
                <button class="quiz-btn next-btn d-none" id="nextBtn" onclick="nextQuestion()">التالي</button>
                <button class="quiz-btn submit-btn d-none" id="submitEssayBtn" onclick="submitEssay()">تسليم</button>
            </div>
        </div>

        <div id="finalFormContainer" class="final-form">
            <h3 class="text-center mb-4">أدخل بياناتك</h3>
            <input type="text" id="studentName" placeholder="الاسم الكامل" required>
            <input type="text" id="studentId" placeholder="(ID)" required>
            <div class="quiz-btns mt-3">
                <button class="quiz-btn next-btn" onclick="saveStudentData()">حفظ</button>
            </div>
        </div>

        <div id="resultContainer" class="result-container">
            <h2>🎉 انتهيت من الاختبار!</h2>
            <div class="result-score" id="finalScore">0/2</div>
            <div class="result-text" id="resultText">أحسنت! واصل التميز 🌟</div>
            <div id="explanationsContainer"></div>
            <div class="mt-4">
                <h4>شارك نتيجتك أو احفظها</h4>
                <div class="input-group mb-3">
                    <span class="input-group-text">+<input type="text" id="countryCode" placeholder="رمز الدولة" style="max-width:80px; text-align:center;" value="20"></span>
                    <input type="text" id="phoneNumber" class="form-control" placeholder="رقم الهاتف (بدون صفر)">
                </div>
                <div class="quiz-btns">
                    <button class="quiz-btn back-btn" onclick="shareToWhatsApp()">
                        <i class="fab fa-whatsapp"></i> إرسال عبر واتساب
                    </button>
                    <button class="quiz-btn next-btn" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf"></i> تحميل كـ PDF
                    </button>
                    <button class="quiz-btn restart-btn" onclick="restartQuiz()">
                        <i class="fas fa-redo"></i> إعادة الاختبار
                    </button>
                    <button class="quiz-btn back-btn" onclick="backToMaterials()">
                        <i class="fas fa-list"></i> العودة للمواد
                    </button>
                </div>
            </div>
        </div>

        <a href="materials.html" class="back-to-home-btn">
            <i class="fas fa-arrow-left me-2"></i> العودة للمواد
        </a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeapYypO595vcDWUoh1gOncsGkQ5EZdyE",
            authDomain: "sit-el-kol.firebaseapp.com",
            projectId: "sit-el-kol",
            storageBucket: "sit-el-kol.firebasestorage.app",
            messagingSenderId: "573924344198",
            appId: "1:573924344198:web:fec2e9a54c1c152cd16c07"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.saveToFirebase = async function(data) {
            try {
                await addDoc(collection(db, "quiz_submissions"), data);
            } catch (e) {
                console.error("فشل حفظ البيانات:", e);
            }
        };
    </script>

    <script>
        const questions = [
            {
                type: "mcq",
                question: "أي من النماذج التالية يعتمد على التطوير التكراري والمتزايد؟",
                options: ["نموذج الشلال", "النموذج الرشيق (Agile)", "نموذج V", "النموذج الخطي"],
                correct: 1,
                explanation: "النموذج الرشيق (Agile) يعتمد على تقسيم المشروع إلى دورات قصيرة تسمى 'sprints' مما يسمح بالتطوير التكراري والتكيف مع التغييرات."
            },
            {
                type: "essay",
                question: "اشرح باختصار الغرض من مخطط علاقات الكيانات (ERD).",
                modelAnswer: "مخطط علاقات الكيانات (ERD) هو أداة تستخدم في تصميم قواعد البيانات لتصوير الكيانات (مثل الطلاب، الدورات) والسمات الخاصة بها، والعلاقات التي تربط بين هذه الكيانات."
            }
        ];

        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let mcqCount = questions.filter(q => q.type === 'mcq').length;

        function saveProgress() {
            localStorage.setItem('quiz-system-d', JSON.stringify({
            currentQuestionIndex, userAnswers, score, mcqCount
            }));
        }

        function loadProgress() {
            const saved = localStorage.getItem('quiz-system-d');
            if (saved) {
            const p = JSON.parse(saved);
            currentQuestionIndex = p.currentQuestionIndex;
            userAnswers = p.userAnswers || [];
            score = p.score || 0;
            mcqCount = p.mcqCount || 0;
            document.getElementById('quizContainer').style.display = 'block';
            loadQuestion();
            return true;
            }
            return false;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const root = document.documentElement;
            if (localStorage.getItem('theme') === 'day') {
            root.classList.add('day-mode');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            document.getElementById('themeToggle').addEventListener('click', () => {
            if (root.classList.contains('day-mode')) {
            root.classList.remove('day-mode');
            localStorage.setItem('theme', 'night');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
            } else {
            root.classList.add('day-mode');
            localStorage.setItem('theme', 'day');
            document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            });

            if (!loadProgress()) {
            document.getElementById('quizContainer').style.display = 'block';
            loadQuestion();
            }
        });

        function loadQuestion() {
            saveProgress();
            const q = questions[currentQuestionIndex];
            document.getElementById('questionCounter').textContent = `السؤال ${currentQuestionIndex + 1} من ${questions.length}`;
            document.getElementById('questionText').textContent = q.question;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            document.getElementById('nextBtn').classList.add('d-none');
            document.getElementById('submitEssayBtn').classList.add('d-none');

            if (q.type === 'mcq') {
            q.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn w-100 text-end';
            btn.textContent = opt;
            btn.onclick = () => selectMCQ(btn, idx);
            container.appendChild(btn);
            });
            if (userAnswers[currentQuestionIndex] !== undefined) {
            const btns = container.querySelectorAll('.option-btn');
            const ans = userAnswers[currentQuestionIndex];
            if (btns[ans]) {
            btns[ans].classList.add('selected');
            showMCQExplanation();
            document.getElementById('nextBtn').classList.remove('d-none');
            }
            }
            } else if (q.type === 'essay') {
            const ta = document.createElement('textarea');
            ta.className = 'essay-input';
            ta.placeholder = 'اكتب إجابتك هنا...';
            if (userAnswers[currentQuestionIndex]) {
            ta.value = userAnswers[currentQuestionIndex];
            }
            container.appendChild(ta);
            document.getElementById('submitEssayBtn').classList.remove('d-none');
            }
        }

        function selectMCQ(btn, idx) {
            document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected', 'correct', 'wrong'));
            btn.classList.add('selected');
            userAnswers[currentQuestionIndex] = idx;
            saveProgress();

            const q = questions[currentQuestionIndex];
            if (idx === q.correct) {
            btn.classList.add('correct');
            score++;
            } else {
            btn.classList.add('wrong');
            const correctBtn = document.getElementById('optionsContainer').querySelectorAll('.option-btn')[q.correct];
            if (correctBtn) correctBtn.classList.add('correct');
            }
            showMCQExplanation();
            document.getElementById('nextBtn').classList.remove('d-none');
        }

        function showMCQExplanation() {
            const q = questions[currentQuestionIndex];
            let exp = document.querySelector('.explanation-temp');
            if (!exp) {
            exp = document.createElement('div');
            exp.className = 'explanation explanation-temp';
            exp.innerHTML = `<h5>الشرح:</h5><p>${q.explanation}</p>`;
            document.getElementById('optionsContainer').appendChild(exp);
            }
        }

        function submitEssay() {
            const ta = document.querySelector('.essay-input');
            const ans = ta.value.trim();
            if (!ans) { alert('يرجى كتابة إجابة.'); return; }
            userAnswers[currentQuestionIndex] = ans;
            saveProgress();

            document.getElementById('submitEssayBtn').classList.add('d-none');

            const q = questions[currentQuestionIndex];
            const exp = document.createElement('div');
            exp.className = 'explanation';
            exp.innerHTML = `<h5>الإجابة النموذجية:</h5><p>${q.modelAnswer}</p>`;
            document.getElementById('optionsContainer').appendChild(exp);

            document.getElementById('nextBtn').classList.remove('d-none');
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
            loadQuestion();
            } else {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('finalFormContainer').style.display = 'block';
            }
        }

        function saveStudentData() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            if (!name || !id) { alert('أدخل الاسم وال ID.'); return; }

            const data = {
            studentName: name,
            studentId: id,
            subjectName: " منظومة الحاسب",
            section: "د",
            score: score,
            totalMCQ: mcqCount,
            percentage: mcqCount ? Math.round((score / mcqCount) * 100) : 0,
            timestamp: new Date().toISOString(),
            answers: userAnswers.map((a, i) => ({
            question: questions[i].question,
            type: questions[i].type,
            userAnswer: a,
            correctAnswer: questions[i].type === 'mcq' ? questions[i].options[questions[i].correct] : null,
            explanation: questions[i].type === 'mcq' ? questions[i].explanation : questions[i].modelAnswer
            }))
            };

            if (window.saveToFirebase) window.saveToFirebase(data);

            localStorage.removeItem('quiz-system-d');
            showFinalResults(name, id, data.percentage);
        }

        function showFinalResults(name, id, pct) {
            document.getElementById('finalFormContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';

            document.getElementById('finalScore').textContent = `${score}/${mcqCount}`;
            let txt = "حاول مرة أخرى! 💪";
            if (pct >= 80) txt = "ممتاز! 🌟";
            else if (pct >= 60) txt = "جيد جدًا! 👍";
            else if (pct >= 40) txt = "لابأس! 📚";
            document.getElementById('resultText').textContent = txt;

            const expCont = document.getElementById('explanationsContainer');
            expCont.innerHTML = '<h3 class="text-light mb-4">جميع إجاباتك:</h3>';
            questions.forEach((q, i) => {
            const div = document.createElement('div');
            div.className = 'explanation';
            const userAns = userAnswers[i] || "لم تجب";
            if (q.type === 'mcq') {
            div.innerHTML = `
            <h5>السؤال ${i+1}: ${q.question}</h5>
            <p><strong>إجابتك:</strong> ${q.options[userAns] || 'لم تجب'}</p>
            <p><strong>الإجابة الصحيحة:</strong> ${q.options[q.correct]}</p>
            <p><strong>الشرح:</strong> ${q.explanation}</p>
            `;
            } else {
            div.innerHTML = `
            <h5>السؤال ${i+1} (مقالي): ${q.question}</h5>
            <p><strong>إجابتك:</strong> ${userAns}</p>
            <p><strong>الإجابة النموذجية:</strong> ${q.modelAnswer}</p>
            `;
            }
            expCont.appendChild(div);
            });
        }

        function shareToWhatsApp() {
            const cc = document.getElementById('countryCode').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            if (!cc || !phone) { alert('أدخل رمز الدولة ورقم الهاتف.'); return; }
            const full = cc + phone.replace(/^0+/, '');
            const msg = `لقد انتهيت من اختبار "منظومة الحاسب - المجموعة د" وحصلت على ${score}/${mcqCount}!`;
            window.open(`https://wa.me/${full}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont('Amiri'); 
            doc.text('نتائج الاختبار', 105, 20, null, null, 'center');
            doc.text('منظومة الحاسب - المجموعة د', 20, 40);
            doc.text(`النتيجة: ${score}/${mcqCount}`, 20, 50);
            let y = 70;
            questions.forEach((q, i) => {
            if (y > 250) { doc.addPage(); y = 20; }
            doc.text(`السؤال ${i+1}: ${q.question}`, 20, y, { maxWidth: 170 });
            y += 10;
            const ans = userAnswers[i] || 'لم تجب';
            if (q.type === 'mcq') {
            doc.text(`إجابتك: ${q.options[ans] || 'لم تجب'}`, 25, y, { maxWidth: 165 });
            y += 10;
            doc.text(`الصحيحة: ${q.options[q.correct]}`, 25, y, { maxWidth: 165 });
            } else {
            doc.text(`إجابتك: ${ans}`, 25, y, { maxWidth: 165 });
            }
            y += 15;
            });
            doc.save('نتيجة_منظومة الحاسب_د.pdf');
        }

        function restartQuiz() {
            localStorage.removeItem('quiz-system-d');
            currentQuestionIndex = 0; userAnswers = []; score = 0;
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            loadQuestion();
        }

        function backToMaterials() {
            localStorage.removeItem('quiz-system-d');
            window.location.href = 'materials.html';
        }

        function exitQuiz() {
            if (confirm('هل تريد إنهاء الاختبار؟')) {
            localStorage.removeItem('quiz-system-d');
            window.location.href = 'materials.html';
            }
        }
    </script>
</body>
</html>