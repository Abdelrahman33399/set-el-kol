<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" href="../../Image_fx6.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
       :root {
    /* Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© */
    --bg-color: #121212; /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ø®Ù„ÙÙŠØ© */
    --card-bg: rgba(255, 255, 255, 0.05); /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø´ÙØ§ÙØ© Ù…Ø¹ ØªØ¯Ø±Ø¬ */
    --border-color: rgba(255, 255, 255, 0.1);
    --text-light: #e0e0e0; /* Ù„ÙˆÙ† ÙØ§ØªØ­ Ù„Ù„Ù†ØµÙˆØµ */
    --primary-neon: linear-gradient(45deg, #a453ff, #54aaff); /* Ù†ÙŠÙˆÙ† Ù…ØªØ¯Ø±Ø¬ Ø¨Ù†ÙØ³Ø¬ÙŠ ÙˆØ£Ø²Ø±Ù‚ */
    --accent-orange: #ff6b35; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ØºØ§Ù…Ù‚ Ù…Ø±ÙŠØ­ Ù„Ù„Ø¹ÙŠÙ† */
    --accent-orange-hover: #e05a2a;
    --shadow-purple: rgba(164, 83, 255, 0.5);
    --shadow-orange: rgba(255, 107, 53, 0.5);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ - Ù…Ø±ÙŠØ­ Ù…Ø¹ ØªØ¯Ø±Ø¬Ø§Øª Ø£Ø²Ø±Ù‚/Ø¨Ù†ÙØ³Ø¬ÙŠ */
:root.day-mode {
    --bg-color: #1b405f; /* Ø®Ù„ÙÙŠØ© Ø²Ø±Ù‚Ø§Ø¡ ÙØ§ØªØ­Ø© Ù†Ø§Ø¹Ù…Ø© */
    --card-bg: rgb(88, 93, 113); /* ÙƒØ±ÙˆØª Ø¨ÙŠØ¶Ø§Ø¡ Ø´Ø¨Ù‡ Ø´ÙØ§ÙØ© */
    --border-color: rgba(130, 130, 255, 0.2);
    --text-light: #ec6211; /* â† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø§Ù„Ø£Ø³ÙˆØ¯ â€” Ø¨Ø§ÙŠÙ†Ø© ÙˆÙˆØ§Ø¶Ø­Ø© */
    --primary-neon: linear-gradient(45deg, #ffffff, #ffffff); /* Ø¨Ù†ÙØ³Ø¬ÙŠ â†’ Ø£Ø²Ø±Ù‚ â€” ØªØ¯Ø±Ø¬ Ù†Ù‡Ø§Ø±ÙŠ Ø£Ù†ÙŠÙ‚ */
    --accent-orange: #e65c00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ ØªØ±Ø§Ø¨ÙŠ â€” Ù…Ø´ Ø­Ø§Ø±Ù‚ */
    --accent-orange-hover: #cc5200;
    --shadow-purple: rgb(255, 255, 255);
    --shadow-orange: rgba(230, 92, 0, 0.592);
}
        body {
            background-color: var(--bg-color);
            color: var(--text-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s;
        }
        .quiz-container, .final-form, .result-container {
            display: none;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 20px;
            margin: 2rem auto;
            max-width: 800px;
            border: 1px solid var(--border-color);
        }
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .question-counter {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--accent-orange);
        }
        .question-text {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: var(--text-light);
            font-weight: 600;
        }
        .options-container {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .option-btn {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ddd;
            padding: 1rem;
            border-radius: 12px;
            text-align: right;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1.1rem;
        }
        .option-btn:hover {
            background: rgba(255, 107, 53, 0.2);
            color: var(--text-light);
        }
        .option-btn.selected {
            background: var(--accent-orange);
            color: white;
            transform: scale(1.02);
        }
        .option-btn.correct {
            background: #28a745;
            color: white;
        }
        .option-btn.wrong {
            background: #dc3545;
            color: white;
        }
        .essay-input {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 1.1rem;
            resize: vertical;
            margin-bottom: 1.5rem;
        }
        .quiz-btns {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
            flex-wrap: wrap;
        }
        .quiz-btn {
            padding: 12px 30px;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }
        .next-btn, .submit-btn {
            background: var(--accent-orange);
            color: white;
        }
        .next-btn:hover, .submit-btn:hover {
            background: #e05a2a;
        }
        .restart-btn {
            background: #6c757d;
            color: white;
        }
        .back-btn {
            background: #28a745;
            color: white;
        }
        .result-score {
            font-size: 3rem;
            font-weight: 800;
            background: var(--primary-neon);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 1rem 0;
        }
        .result-text {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: var(--text-light);
        }
        .explanation {
            background: rgba(255, 255, 255, 0.05);
            padding: 1.5rem;
            border-radius: 12px;
            margin: 1.5rem 0;
            text-align: right;
            border-right: 4px solid var(--accent-orange);
        }
        .explanation h5 {
            color: var(--accent-orange);
            margin-bottom: 0.5rem;
        }
        .final-form input {
            width: 100%;
            padding: 12px;
            margin: 0.5rem 0;
            border-radius: 12px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            font-size: 1.1rem;
        }
        .theme-toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--accent-orange);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 1000;
        }
        .back-to-home-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle-btn">
        <i class="fas fa-moon"></i>
    </button>

    <div class="container py-5">
        <!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± -->
        <div id="quizContainer" class="quiz-container">
            <div class="quiz-header">
                <div class="question-counter" id="questionCounter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 2</div>
                <button class="btn btn-outline-light" onclick="exitQuiz()">
                    <i class="fas fa-times"></i> Ø¥Ù†Ù‡Ø§Ø¡
                </button>
            </div>
            <div class="question-text" id="questionText">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§...</div>
            <div class="options-container" id="optionsContainer"></div>
            <div class="quiz-btns">
                <button class="quiz-btn next-btn d-none" id="nextBtn" onclick="nextQuestion()">Ø§Ù„ØªØ§Ù„ÙŠ</button>
                <button class="quiz-btn submit-btn d-none" id="submitEssayBtn" onclick="submitEssay()">ØªØ³Ù„ÙŠÙ…</button>
            </div>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù€ID -->
        <div id="finalFormContainer" class="final-form">
            <h3 class="text-center mb-4">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h3>
            <input type="text" id="studentName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required>
            <input type="text" id="studentId" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ (ID)" required>
            <div class="quiz-btns mt-3">
                <button class="quiz-btn next-btn" onclick="saveStudentData()">Ø­ÙØ¸</button>
            </div>
        </div>

        <!-- ØµÙØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© -->
        <div id="resultContainer" class="result-container">
            <h2>ğŸ‰ Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</h2>
            <div class="result-score" id="finalScore">0/2</div>
            <div class="result-text" id="resultText">Ø£Ø­Ø³Ù†Øª! ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ…ÙŠØ² ğŸŒŸ</div>
            <div id="explanationsContainer"></div>
            <div class="mt-4">
                <h4>Ø´Ø§Ø±Ùƒ Ù†ØªÙŠØ¬ØªÙƒ Ø£Ùˆ Ø§Ø­ÙØ¸Ù‡Ø§</h4>
                <div class="input-group mb-3">
                    <span class="input-group-text">+<input type="text" id="countryCode" placeholder="Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©" style="max-width:80px; text-align:center;" value="20"></span>
                    <input type="text" id="phoneNumber" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø¨Ø¯ÙˆÙ† ØµÙØ±)">
                </div>
                <div class="quiz-btns">
                    <button class="quiz-btn back-btn" onclick="shareToWhatsApp()">
                        <i class="fab fa-whatsapp"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                    </button>
                    <button class="quiz-btn next-btn" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf"></i> ØªØ­Ù…ÙŠÙ„ ÙƒÙ€ PDF
                    </button>
                    <button class="quiz-btn restart-btn" onclick="restartQuiz()">
                        <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                    <button class="quiz-btn back-btn" onclick="backToMaterials()">
                        <i class="fas fa-list"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
                    </button>
                </div>
            </div>
        </div>

        <a href="materials.html" class="back-to-home-btn">
            <i class="fas fa-arrow-left me-2"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ÙˆØ§Ø¯
        </a>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeapYypO595vcDWUoh1gOncsGkQ5EZdyE",
            authDomain: "sit-el-kol.firebaseapp.com",
            projectId: "sit-el-kol",
            storageBucket: "sit-el-kol.firebasestorage.app",
            messagingSenderId: "573924344198",
            appId: "1:573924344198:web:fec2e9a54c1c152cd16c07"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.saveToFirebase = async function(data) {
            try {
                await addDoc(collection(db, "quiz_submissions"), data);
            } catch (e) {
                console.error("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", e);
            }
        };
    </script>

    <script>
        // Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£
        const questions = [
            {
                type: "mcq",
                question: "Ù…Ø§ Ù‡Ùˆ Ø¬Ù…Ø¹ ÙƒÙ„Ù…Ø© 'ÙƒØªØ§Ø¨'ØŸ",
                options: ["ÙƒØªØ¨", "ÙƒØªØ§Ø¨Ø§Øª", "ÙƒØªÙˆØ¨", "ÙƒØªØ§Ø¨ÙŠ"],
                correct: 0,
                explanation: "Ø¬Ù…Ø¹ ÙƒÙ„Ù…Ø© 'ÙƒØªØ§Ø¨' Ù‡Ùˆ 'ÙƒØªØ¨'."
            },
            {
                type: "mcq",
                question: "Ø£ÙŠ Ù…Ù† Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù‡ÙŠ ÙØ¹Ù„ØŸ",
                options: ["Ù…Ø¯Ø±Ø³Ø©", "ÙŠÙƒØªØ¨", "Ø¬Ù…ÙŠÙ„", "ÙƒØªØ§Ø¨"],
                correct: 1,
                explanation: "'ÙŠÙƒØªØ¨' Ù‡Ùˆ ÙØ¹Ù„ØŒ Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø£Ùˆ ØµÙØ§Øª."
            },
            {
                type: "essay",
                question: "Ø§Ø´Ø±Ø­ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø§Ø³Ù…ÙŠØ© ÙˆØ§Ù„ÙØ¹Ù„ÙŠØ© ÙÙŠ Ø³Ø·Ø±ÙŠÙ†.",
                modelAnswer: "Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„Ø§Ø³Ù…ÙŠØ© ØªØ¨Ø¯Ø£ Ø¨Ø§Ø³Ù… (Ù…Ø¨ØªØ¯Ø£) ÙˆÙŠØªØ¨Ø¹Ù‡ Ø®Ø¨Ø±ØŒ Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© ØªØ¨Ø¯Ø£ Ø¨ÙØ¹Ù„ ÙˆÙŠØªØ¨Ø¹Ù‡ ÙØ§Ø¹Ù„."
            }
        ];

        let currentQuestionIndex = 0;
        let userAnswers = [];
        let score = 0;
        let mcqCount = questions.filter(q => q.type === 'mcq').length;

        // === LocalStorage ===
        function saveProgress() {
            const progress = {
                currentQuestionIndex,
                userAnswers,
                score,
                mcqCount
            };
            localStorage.setItem('quizProgress-arabic-a', JSON.stringify(progress));
        }

        function loadProgress() {
            const saved = localStorage.getItem('quizProgress-arabic-a');
            if (saved) {
                const progress = JSON.parse(saved);
                currentQuestionIndex = progress.currentQuestionIndex;
                userAnswers = progress.userAnswers || [];
                score = progress.score || 0;
                mcqCount = progress.mcqCount || 0;
                document.getElementById('quizContainer').style.display = 'block';
                loadQuestion();
            }
        }

        // === DOMContentLoaded ===
        document.addEventListener('DOMContentLoaded', function() {
            const root = document.documentElement;
            if (localStorage.getItem('theme') === 'day') {
                root.classList.add('day-mode');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
            }
            document.getElementById('themeToggle').addEventListener('click', () => {
                if (root.classList.contains('day-mode')) {
                    root.classList.remove('day-mode');
                    localStorage.setItem('theme', 'night');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    root.classList.add('day-mode');
                    localStorage.setItem('theme', 'day');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
            });

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„ØªÙ‚Ø¯Ù…
            if (!loadProgress()) {
                document.getElementById('quizContainer').style.display = 'block';
                loadQuestion();
            }
        });

        // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ ===
        function loadQuestion() {
            saveProgress();
            const q = questions[currentQuestionIndex];
            document.getElementById('questionCounter').textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${currentQuestionIndex + 1} Ù…Ù† ${questions.length}`;
            document.getElementById('questionText').textContent = q.question;

            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            document.getElementById('nextBtn').classList.add('d-none');
            document.getElementById('submitEssayBtn').classList.add('d-none');

            if (q.type === 'mcq') {
                q.options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'option-btn w-100 text-end';
                    button.textContent = option;
                    button.onclick = () => selectMCQOption(button, index);
                    container.appendChild(button);
                });
                if (userAnswers[currentQuestionIndex] !== undefined) {
                    const btns = container.querySelectorAll('.option-btn');
                    const ans = userAnswers[currentQuestionIndex];
                    if (btns[ans]) {
                        btns[ans].classList.add('selected');
                        showMCQExplanation();
                        document.getElementById('nextBtn').classList.remove('d-none');
                    }
                }
            } else if (q.type === 'essay') {
                const textarea = document.createElement('textarea');
                textarea.className = 'essay-input';
                textarea.placeholder = 'Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§...';
                if (userAnswers[currentQuestionIndex]) {
                    textarea.value = userAnswers[currentQuestionIndex];
                }
                container.appendChild(textarea);
                document.getElementById('submitEssayBtn').classList.remove('d-none');
            }
        }

        // === Ø§Ø®ØªÙŠØ§Ø± MCQ ===
        function selectMCQOption(button, answerIndex) {
            document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected', 'correct', 'wrong'));
            button.classList.add('selected');
            userAnswers[currentQuestionIndex] = answerIndex;
            saveProgress();

            const q = questions[currentQuestionIndex];
            if (answerIndex === q.correct) {
                button.classList.add('correct');
                score += 1;
            } else {
                button.classList.add('wrong');
                const correctBtn = document.querySelectorAll('.option-btn')[q.correct];
                if (correctBtn) correctBtn.classList.add('correct');
            }
            showMCQExplanation();
            document.getElementById('nextBtn').classList.remove('d-none');
        }

        function showMCQExplanation() {
            const q = questions[currentQuestionIndex];
            const existing = document.querySelector('.explanation-temp');
            if (existing) return;
            const div = document.createElement('div');
            div.className = 'explanation explanation-temp';
            div.innerHTML = `<h5>Ø§Ù„Ø´Ø±Ø­:</h5><p>${q.explanation}</p>`;
            document.getElementById('optionsContainer').appendChild(div);
        }

        // === ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ù‚Ø§Ù„ÙŠ ===
        function submitEssay() {
            const textarea = document.querySelector('.essay-input');
            const answer = textarea.value.trim();
            if (!answer) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ….');
                return;
            }
            userAnswers[currentQuestionIndex] = answer;
            saveProgress();

            document.getElementById('submitEssayBtn').classList.add('d-none');

            const q = questions[currentQuestionIndex];
            const div = document.createElement('div');
            div.className = 'explanation';
            div.innerHTML = `<h5>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</h5><p>${q.modelAnswer}</p>`;
            document.getElementById('optionsContainer').appendChild(div);

            document.getElementById('nextBtn').classList.remove('d-none');
        }

        // === Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ ===
        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                loadQuestion();
            } else {
                document.getElementById('quizContainer').style.display = 'none';
                document.getElementById('finalFormContainer').style.display = 'block';
            }
        }

        // === Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ===
        function saveStudentData() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            if (!name || !id) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ.');
                return;
            }

            const submissionData = {
                studentName: name,
                studentId: id,
                subjectName: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                section: "Ø£",
                score: score,
                totalMCQ: mcqCount,
                percentage: mcqCount ? Math.round((score / mcqCount) * 100) : 0,
                timestamp: new Date().toISOString(),
                answers: userAnswers.map((ans, i) => ({
                    question: questions[i].question,
                    type: questions[i].type,
                    userAnswer: ans,
                    correctAnswer: questions[i].type === 'mcq' ? questions[i].options[questions[i].correct] : null,
                    explanation: questions[i].type === 'mcq' ? questions[i].explanation : questions[i].modelAnswer
                }))
            };

            if (window.saveToFirebase) {
                window.saveToFirebase(submissionData);
            }

            localStorage.removeItem('quizProgress-arabic-a');
            showFinalResults(name, id, submissionData.percentage);
        }

        // === Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ===
        function showFinalResults(name, id, percentage) {
            document.getElementById('finalFormContainer').style.display = 'none';
            document.getElementById('resultContainer').style.display = 'block';

            const total = mcqCount;
            document.getElementById('finalScore').textContent = `${score}/${total}`;
            let resultText = "";
            if (percentage >= 80) resultText = "Ù…Ù…ØªØ§Ø²! ğŸŒŸ Ø£Ù†Øª Ù…ØªÙ…ÙŠØ²!";
            else if (percentage >= 60) resultText = "Ø¬ÙŠØ¯ Ø¬Ø¯Ù‹Ø§! ğŸ‘ ÙˆØ§ØµÙ„ Ø§Ù„ØªÙ‚Ø¯Ù…!";
            else if (percentage >= 40) resultText = "Ù„Ø§Ø¨Ø£Ø³! ğŸ“š ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø³ÙŠØ·Ø©.";
            else resultText = "Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰! ğŸ’ª Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ù‡ØªØ³Ø§Ø¹Ø¯Ùƒ!";
            document.getElementById('resultText').textContent = resultText;

            const explanationsContainer = document.getElementById('explanationsContainer');
            explanationsContainer.innerHTML = '<h3 class="text-light mb-4">Ø¬Ù…ÙŠØ¹ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ:</h3>';
            questions.forEach((q, i) => {
                const userAnswer = userAnswers[i] || "Ù„Ù… ØªØ¬Ø¨";
                const div = document.createElement('div');
                div.className = 'explanation';
                if (q.type === 'mcq') {
                    div.innerHTML = `
                        <h5>Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1}: ${q.question}</h5>
                        <p><strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${q.options[userAnswer] || 'Ù„Ù… ØªØ¬Ø¨'}</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${q.options[q.correct]}</p>
                        <p><strong>Ø§Ù„Ø´Ø±Ø­:</strong> ${q.explanation}</p>
                    `;
                } else {
                    div.innerHTML = `
                        <h5>Ø§Ù„Ø³Ø¤Ø§Ù„ ${i + 1} (Ù…Ù‚Ø§Ù„ÙŠ): ${q.question}</h5>
                        <p><strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${userAnswer}</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©:</strong> ${q.modelAnswer}</p>
                    `;
                }
                explanationsContainer.appendChild(div);
            });
        }

        // === ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© ===
        function shareToWhatsApp() {
            const countryCode = document.getElementById('countryCode').value.trim();
            const phone = document.getElementById('phoneNumber').value.trim();
            if (!countryCode || !phone) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø© ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ.');
                return;
            }
            const fullPhone = countryCode + phone.replace(/^0+/, '');
            const scoreText = document.getElementById('finalScore').textContent;
            const resultText = document.getElementById('resultText').textContent;
            const message = `Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡ÙŠØª Ù…Ù† Ø§Ø®ØªØ¨Ø§Ø± "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£" ÙˆØ­ØµÙ„Øª Ø¹Ù„Ù‰ ${scoreText}! ${resultText}`;
            window.open(`https://wa.me/${fullPhone}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFont('Amiri', 'normal');
            doc.text('Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 105, 20, null, null, 'center');
            doc.text(`Ø§Ù„Ù…Ø§Ø¯Ø©: Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© - Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£`, 20, 40);
            doc.text(`Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${document.getElementById('finalScore').textContent}`, 20, 50);
            doc.text(`Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${document.getElementById('resultText').textContent}`, 20, 60);
            doc.text('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª:', 20, 80);

            let y = 90;
            questions.forEach((q, i) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`Ø§Ù„Ø³Ø¤Ø§Ù„ ${i+1}: ${q.question}`, 20, y);
                y += 10;
                if (q.type === 'mcq') {
                    const userAns = q.options[userAnswers[i]] || 'Ù„Ù… ØªØ¬Ø¨';
                    doc.text(`Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userAns}`, 25, y);
                    y += 10;
                    doc.text(`Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©: ${q.options[q.correct]}`, 25, y);
                } else {
                    doc.text(`Ø¥Ø¬Ø§Ø¨ØªÙƒ: ${userAnswers[i] || 'Ù„Ù… ØªØ¬Ø¨'}`, 25, y);
                }
                y += 15;
            });
            doc.save(`Ù†ØªÙŠØ¬Ø©_Ø§Ø®ØªØ¨Ø§Ø±_Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©_Ø£.pdf`);
        }

        // === ÙˆØ¸Ø§Ø¦Ù Ø£Ø®Ø±Ù‰ ===
        function restartQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            score = 0;
            localStorage.removeItem('quizProgress-arabic-a');
            document.getElementById('resultContainer').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            loadQuestion();
        }

        function backToMaterials() {
            document.getElementById('resultContainer').style.display = 'none';
            window.location.href = 'materials.html';
        }

        function exitQuiz() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) {
                localStorage.removeItem('quizProgress-arabic-a');
                window.location.href = 'materials.html';
            }
        }
    </script>
</body>
</html>