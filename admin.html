<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <link rel="icon" href="Image_fx6.jpg" type="image/x-icon">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=overlays-content">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ | Ø³Øª Ø§Ù„ÙƒÙ„</title>

  <!-- ØªØ­Ø³ÙŠÙ† Ø¨Ø³ÙŠØ· Ù„Ù„Ø£Ø¯Ø§Ø¡ -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --admin-primary: #1a237e;
      --admin-accent: #ffd700;
      --admin-danger: #dc3545;
    }
    body {
      background-color: #0f142e;
      color: #e9ecef;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .admin-header {
      background: var(--admin-primary);
      padding: 1.2rem;
      border-radius: 16px 16px 0 0;
      margin-bottom: 1.5rem;
      text-align: center;
      border-bottom: 3px solid var(--admin-accent);
    }
    .admin-header h1 {
      color: white;
      font-weight: 800;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    @media (min-width: 768px) {
      .admin-header h1 { font-size: 1.8rem; }
    }
    .admin-header p {
      color: #c1c1c1;
      margin: 0;
      font-size: 0.95rem;
    }
    .admin-card {
      background: rgba(30, 35, 60, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 1.8rem;
      border: 1px solid rgba(255, 215, 0, 0.3);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
    }
    .admin-card h3 {
      color: var(--admin-accent);
      font-weight: 700;
      margin-bottom: 1.2rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(255, 215, 0, 0.2);
      font-size: 1.3rem;
    }
    .user-item, .result-item {
      background: rgba(255, 255, 255, 0.08);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 215, 0, 0.15);
      transition: all 0.3s ease;
    }
    .user-item:hover, .result-item:hover {
      background: rgba(255, 215, 0, 0.05);
      transform: translateY(-2px);
    }
    .user-item h5, .result-item h5 {
      margin: 0 0 0.4rem 0;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      word-break: break-word;
    }
    .user-item p, .result-item p {
      color: #adb5bd;
      margin: 0.2rem 0;
      font-size: 0.9rem;
      word-break: break-word;
    }
    .badge-admin {
      background: var(--admin-accent);
      color: #000;
      font-weight: 600;
      font-size: 0.8rem;
    }
    .badge-user {
      background: #6c757d;
      color: white;
      font-size: 0.8rem;
    }
    .badge-banned {
      background: var(--admin-danger);
      color: white;
      font-size: 0.8rem;
    }
    .score-badge {
      background: #28a745;
      color: white;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9rem;
    }
    .btn-admin, .btn-danger-sm, .btn-warning-sm, .btn-view {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      margin: 0.2rem 0;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn-admin, .btn-view {
      background: var(--admin-accent);
      color: #000;
      border: none;
    }
    .btn-admin:hover, .btn-view:hover {
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
    }
    .btn-danger-sm {
      background: var(--admin-danger);
      color: white;
      border: none;
    }
    .btn-danger-sm:hover {
      background: #c82333;
      transform: translateY(-2px);
    }
    .btn-warning-sm {
      background: #ffc107;
      color: #000;
      border: none;
    }
    .btn-warning-sm:hover {
      background: #e0a800;
      transform: translateY(-2px);
    }
    .action-btns {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.8rem;
      margin-bottom: 1.5rem;
    }
    .btn-action {
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      white-space: nowrap;
    }
    .home-btn {
      background: #ff6b35;
      color: white;
    }
    .home-btn:hover {
      background: #e05a2a;
      transform: translateY(-3px) scale(1.03);
      box-shadow: 0 8px 25px rgba(255, 107, 53, 0.5);
    }
    .visits-count {
      background: rgba(0, 123, 255, 0.2);
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.8rem;
      color: #4dabf7;
      border: 1px solid rgba(0, 123, 255, 0.3);
      display: inline-block;
      margin-top: 0.3rem;
    }
    @media (max-width: 767px) {
      .user-item > .d-flex, .result-item > .d-flex {
        flex-direction: column !important;
        align-items: stretch !important;
      }
      .user-item > .d-flex > div:last-child, .result-item > .d-flex > div:last-child {
        margin-top: 1rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        justify-content: center;
      }
      .admin-header, .admin-card { padding: 1rem; }
      .btn-action { width: 100%; justify-content: center; }
      .modal-dialog { margin: 0.5rem; max-width: none; }
      .modal-content { font-size: 0.95rem; }
      .form-control { font-size: 1rem; padding: 0.6rem; }
    }
    .modal-content {
      border-radius: 20px;
      border: none;
      background: rgba(30, 35, 60, 0.95);
      color: white;
    }
    .form-control {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.3);
      color: white;
    }
    .form-control:focus {
      background: rgba(255, 255, 255, 0.15);
      border-color: var(--admin-accent);
      box-shadow: 0 0 0 0.2rem rgba(255, 215, 0, 0.25);
    }
    .btn-close { color: white; }
    .btn-close:hover { color: var(--admin-accent); }

    .explanation-detail {
      background: rgba(40, 45, 75, 0.7);
      padding: 1rem;
      border-radius: 10px;
      margin: 0.8rem 0;
      border-right: 3px solid var(--admin-accent);
    }
    .explanation-detail h6 {
      color: var(--admin-accent);
      margin-bottom: 0.4rem;
    }
    #resultDetailBody h5, #resultDetailBody h6 { color: #ffd700; }
    #resultDetailBody .text-success { color: #66ff66 !important; font-weight: 600; }
    #resultDetailBody .text-danger { color: #ff6666 !important; font-weight: 600; }
    #resultDetailBody .text-info { color: #66ccff !important; }

    /* Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ */
    .load-more-wrap {
      display: flex;
      justify-content: center;
      margin-top: 0.75rem;
    }
    .load-more-wrap .btn {
      min-width: 180px;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="admin-header">
      <h1><i class="fas fa-shield-alt"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h1>
      <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ Ø§Ù„ØªØ§Ø³ÙƒØ§ØªØŒ ÙˆÙ†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</p>
    </div>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <button class="btn btn-admin" data-bs-toggle="modal" data-bs-target="#appointmentModal">
        <i class="fas fa-calendar-plus"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¹Ø§Ù…
      </button>
      <button class="btn btn-danger btn-sm" id="adminLogout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="action-btns mb-4">
      <a href="dashboard.html" class="btn-action home-btn">
        <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
      </a>
    </div>

    <div class="admin-card">
      <h3><i class="fas fa-users-cog"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>

      <div class="mb-3">
        <div class="input-group">
          <input type="text" id="userSearch" class="form-control bg-secondary text-light" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ ID..." />
          <button class="btn btn-admin" id="clearSearch" title="Ù…Ø³Ø­ Ø§Ù„Ø¨Ø­Ø«">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <small class="text-muted">Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ID ÙƒØ§Ù…Ù„ (Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹) â€” ÙˆÙ„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø§Ø³ØªØ®Ø¯Ù… â€œØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯â€</small>
      </div>

      <div id="userSearchSummary"></div>
      <div id="usersList"></div>

      <div class="load-more-wrap">
        <button class="btn btn-admin" id="usersLoadMore" style="display:none;">
          <i class="fas fa-plus"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
        </button>
      </div>
    </div>

    <div class="admin-card">
      <h3><i class="fas fa-calendar-alt"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
      <p class="text-muted mb-3">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
      <div id="globalAppointmentsList"></div>
      <div class="load-more-wrap">
        <button class="btn btn-admin" id="apptsLoadMore" style="display:none;">
          <i class="fas fa-plus"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
        </button>
      </div>
    </div>

    <div class="admin-card">
      <h3><i class="fas fa-tasks"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
      <p class="text-muted mb-3">Ø§Ù„ØªØ§Ø³ÙƒØ§Øª Ù‡Ù†Ø§ ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ ØµÙØ­Ø© "ØªØ§Ø³ÙƒØ§ØªÙŠ"</p>
      <button class="btn btn-admin w-100 mb-3" data-bs-toggle="modal" data-bs-target="#taskModal">
        <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ Ø¹Ø§Ù… Ø¬Ø¯ÙŠØ¯
      </button>
      <div id="globalTasksList"></div>
      <div class="load-more-wrap">
        <button class="btn btn-admin" id="tasksLoadMore" style="display:none;">
          <i class="fas fa-plus"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
        </button>
      </div>
    </div>

    <div class="admin-card">
      <h3><i class="fas fa-graduation-cap"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
      <div id="quizResultsList"></div>
      <div class="load-more-wrap">
        <button class="btn btn-admin" id="resultsLoadMore" style="display:none;">
          <i class="fas fa-plus"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯
        </button>
      </div>
    </div>
  </div>

  <!-- Modal Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ -->
  <div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="appointmentModalLabel">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¹Ø§Ù…</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="appointmentId">
          <div class="mb-3">
            <label class="form-label">Ø§Ù„ÙŠÙˆÙ…</label>
            <select class="form-control bg-secondary text-light" id="appointmentDay" required>
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…</option>
              <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
              <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
              <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">Ø§Ù„Ø§Ø«Ù†ÙŠÙ†</option>
              <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
              <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
              <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
              <option value="Ø§Ù„Ø¬Ù…Ø¹Ø©">Ø§Ù„Ø¬Ù…Ø¹Ø©</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…Ø§Ø¯Ø©</label>
            <input type="text" class="form-control bg-secondary text-light" id="appointmentSubject" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø¨ÙƒØ§Øª" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ø¯ÙƒØªÙˆØ± / Ø§Ù„Ù…ÙØ¹ÙŠØ¯</label>
            <input type="text" class="form-control bg-secondary text-light" id="appointmentDoctor" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø³Ù…ÙŠÙ‡" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„Ù…ÙƒØ§Ù†</label>
            <input type="text" class="form-control bg-secondary text-light" id="appointmentLocation" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø¹Ù…Ù„ 1" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ø§Ù„ÙˆÙ‚Øª</label>
            <input type="time" class="form-control bg-secondary text-light" id="appointmentTime" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-success" id="saveAppointmentBtn">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Ø§Ù„ØªØ§Ø³ÙƒØ§Øª -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalLabel">â• Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ Ø¹Ø§Ù…</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="taskId">
          <div class="mb-3">
            <label class="form-label">ÙˆØµÙ Ø§Ù„ØªØ§Ø³Ùƒ</label>
            <input type="text" id="taskTitle" class="form-control bg-secondary text-light" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„ ØªÙ…Ø§Ø±ÙŠÙ† Ø§Ù„ÙØµÙ„ 3" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
          <button type="button" class="btn btn-admin" id="saveTaskBtn">Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
  <div class="modal fade" id="resultDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background: var(--admin-primary); border-bottom: 2px solid var(--admin-accent);">
          <h5 class="modal-title fw-bold text-white">
            <i class="fas fa-file-medical me-2"></i> ØªÙØ§ØµÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Ø¥ØºÙ„Ø§Ù‚"></button>
        </div>
        <div class="modal-body p-4" id="resultDetailBody"></div>
        <div class="modal-footer d-flex justify-content-between" style="background: rgba(30, 35, 60, 0.9);">
          <button type="button" class="btn btn-outline-danger px-4" id="deleteResultBtn">
            <i class="fas fa-trash-alt me-1"></i> Ø­Ø°Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©
          </button>
          <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">
            <i class="fas fa-times me-1"></i> Ø¥ØºÙ„Ø§Ù‚
          </button>
        </div>
      </div>
    </div>
  </div>
<!-- ØªØ­Ù…ÙŠÙ„ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    updateDoc,
    collection,
    getDocs,
    deleteDoc,
    addDoc,
    query,
    where,
    orderBy,
    limit,
    startAfter
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // âœ… Ø¥ØµÙ„Ø§Ø­ Ù‚ÙŠÙ… config Ø§Ù„Ù„ÙŠ ÙƒØ§Ù†Øª Ø¨ØªØ¸Ù‡Ø± scientific notation Ø¹Ù†Ø¯Ùƒ (Ø¨ØªÙƒØ³Ø± Firebase)
  const firebaseConfig = {
    apiKey: "AIzaSyDeapYypO595vcDWUoh1gOncsGkQ5EZdyE",
    authDomain: "sit-el-kol.firebaseapp.com",
    projectId: "sit-el-kol",
    storageBucket: "sit-el-kol.firebasestorage.app",
    messagingSenderId: "573924344198",
    appId: "1:573924344198:web:fec2e9a54c1c152cd16c07",
    measurementId: "G-CWVJDKPS0M"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  let currentDocId = null;

  // =========================
  // Telegram (ÙƒÙ…Ø§ Ù‡Ùˆ) + ØªØµØ­ÙŠØ­ chat_id
  // =========================
  async function sendTelegramNotification(type, email, uid) {
    try {
      const now = new Date();
      const time = now.toLocaleString('ar-EG', {
        timeZone: 'Africa/Cairo',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });

      const message = type === 'signup'
        ? `âœ… <b>Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡!</b>\nğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${email || "â€”"}\nğŸ†” Ø§Ù„Ù€ User ID: <code>${uid}</code>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª (Ù…ØµØ±): ${time}`
        : `ğŸ“¥ <b>ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„!</b>\nğŸ“§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: ${email || "â€”"}\nğŸ†” Ø§Ù„Ù€ User ID: <code>${uid}</code>\nğŸ•’ Ø§Ù„ÙˆÙ‚Øª (Ù…ØµØ±): ${time}`;

      const response = await fetch("https://api.telegram.org/bot8546756159:AAFq0bbHKffLdG3dzjD3rGcTz9ihv2v4r8Y/sendMessage", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          chat_id: "1645839402",
          text: message,
          parse_mode: "HTML"
        })
      });

      if (!response.ok) {
        const err = await response.json();
        console.warn("âš ï¸ Telegram API Error:", err);
      }
    } catch (err) {
      console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± ØªÙ„ÙŠØ¬Ø±Ø§Ù…:", err.message);
    }
  }

  // =========================
  // Notifications
  // =========================
  function showNotification(msg, type = 'info') {
    const div = document.createElement('div');
    div.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
    div.style.zIndex = 9999;
    div.innerHTML = `<i class="fas fa-bell me-2"></i>${msg}`;
    document.body.appendChild(div);
    setTimeout(() => div.remove(), 3200);
  }

  // =========================
  // Users pagination
  // =========================
  const USERS_PAGE_SIZE = 25;
  let usersLastDoc = null;
  let usersLoading = false;
  let currentUserSearch = "";

  function ensureUsersLoadMoreButton() {
    let btn = document.getElementById('usersLoadMore');
    if (btn) return btn;

    const usersList = document.getElementById('usersList');
    if (!usersList) return null;

    const wrap = document.createElement('div');
    wrap.className = 'd-flex justify-content-center mt-3';

    btn = document.createElement('button');
    btn.id = 'usersLoadMore';
    btn.className = 'btn btn-admin';
    btn.style.display = 'none';
    btn.innerHTML = '<i class="fas fa-plus"></i> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯';

    wrap.appendChild(btn);
    usersList.insertAdjacentElement('afterend', wrap);
    return btn;
  }

  // =========================
  // User actions
  // =========================
  async function toggleUserRole(userId, currentRole) {
    const isSelf = auth.currentUser?.uid === userId;
    if (isSelf) {
      showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø±ØªØ¨ØªÙƒ Ù„Ù†ÙØ³Ùƒ.', 'warning');
      return;
    }

    const nextRole = currentRole === 'admin' ? 'user' : 'admin';
    if (!confirm(`ØªØ£ÙƒÙŠØ¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø±ØªØ¨Ø© Ø¥Ù„Ù‰: ${nextRole === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…'} ØŸ`)) return;

    try {
      await updateDoc(doc(db, "users", userId), { role: nextRole });
      showNotification('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      await loadUsers(currentUserSearch, true);
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©: ' + error.message, 'danger');
    }
  }

  async function toggleUserBan(userId, isCurrentlyBanned) {
    const isSelf = auth.currentUser?.uid === userId;
    if (isSelf) {
      showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø¸Ø± Ù†ÙØ³Ùƒ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.', 'warning');
      return;
    }

    try {
      await updateDoc(doc(db, "users", userId), { banned: !isCurrentlyBanned });
      showNotification(isCurrentlyBanned ? 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!' : 'ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…!', 'warning');
      await loadUsers(currentUserSearch, true);
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±: ' + error.message, 'danger');
    }
  }

  // (Ø§Ù„Ø­Ø°Ù Ù…Ø§Ø²Ø§Ù„ Firestore ÙÙ‚Ø· Ù…Ø¤Ù‚ØªÙ‹Ø§ â€“ Ø²ÙŠ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ)
  async function deleteUser(userId) {
    const isSelf = auth.currentUser?.uid === userId;
    if (isSelf) {
      showNotification('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ù†ÙØ³Ùƒ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†.', 'warning');
      return;
    }

    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
    try {
      await deleteDoc(doc(db, "users", userId));
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      await loadUsers(currentUserSearch, true);
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ' + error.message, 'danger');
    }
  }

  async function manageUserPermissions(userId) {
    const userDoc = await getDoc(doc(db, "users", userId));
    if (!userDoc.exists()) return;

    const userData = userDoc.data();
    const restrictedPages = userData.restrictedPages || [];

    const modal = document.createElement('div');
    modal.className = 'modal fade show';
    modal.style.display = 'block';
    modal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header">
            <h5 class="modal-title">ğŸ” Ø¥Ø¯Ø§Ø±Ø© ØµÙ„Ø§Ø­ÙŠØ§Øª: ${userData.name}</h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeModal()"></button>
          </div>
          <div class="modal-body">
            <p>Ø§Ø®ØªØ± Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªÙ…Ù†Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø¯Ø®ÙˆÙ„Ù‡Ø§:</p>
            <div id="userPermissionsList"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button type="button" class="btn btn-admin" onclick="saveUserPermissions('${userId}')">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
          </div>
        </div>
      </div>
      <div class="modal-backdrop fade show"></div>
    `;
    document.body.appendChild(modal);

    const pages = [
      { id: 'lectures', name: 'Ù…Ø­Ø§Ø¶Ø±Ø§ØªÙŠ' },
      { id: 'sections', name: 'Ø§Ù„Ø³ÙƒØ§Ø´Ù†' },
      { id: 'appointments', name: 'Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ' },
      { id: 'tasks', name: 'ØªØ§Ø³ÙƒØ§ØªÙŠ' },
      { id: 'summaries', name: 'ØªÙ„Ø®ÙŠØµØ§ØªÙŠ' },
      { id: 'questions', name: 'Ø£Ø³Ø¦Ù„ØªÙŠ' }
    ];

    const permissionsList = document.getElementById('userPermissionsList');
    permissionsList.innerHTML = pages.map(page => `
      <div class="form-check mb-2">
        <input class="form-check-input" type="checkbox" id="userPage_${page.id}" ${restrictedPages.includes(page.id) ? 'checked' : ''}>
        <label class="form-check-label" for="userPage_${page.id}">${page.name}</label>
      </div>
    `).join('');
  }

  function closeModal() {
    const modal = document.querySelector('.modal');
    const backdrop = document.querySelector('.modal-backdrop');
    if (modal) modal.remove();
    if (backdrop) backdrop.remove();
  }

  async function saveUserPermissions(userId) {
    const checkboxes = document.querySelectorAll('#userPermissionsList input[type="checkbox"]');
    const restrictedPages = [];
    checkboxes.forEach(cb => {
      if (cb.checked) restrictedPages.push(cb.id.replace('userPage_', ''));
    });

    try {
      await updateDoc(doc(db, "users", userId), { restrictedPages });
      showNotification('ØªÙ… Ø­ÙØ¸ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      closeModal();
      await loadUsers(currentUserSearch, true);
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª: ' + error.message, 'danger');
    }
  }

  // Ø¹Ù„Ø´Ø§Ù† onclick ÙŠØ´ØªØºÙ„
  window.closeModal = closeModal;
  window.saveUserPermissions = saveUserPermissions;

  // =========================
  // Load Users (fast)
  // =========================
  async function loadUsers(searchId = '', reset = true) {
    const usersList = document.getElementById('usersList');
    const btnMore = ensureUsersLoadMoreButton();
    if (!usersList) return;

    currentUserSearch = (searchId || '').trim();

    if (usersLoading) return;
    usersLoading = true;

    if (reset) {
      usersLastDoc = null;
      usersList.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-warning" role="status"><span class="visually-hidden">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span></div></div>';
      if (btnMore) btnMore.style.display = 'none';
    }

    try {
      let snapshot;

      // âœ… Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹ (Exact) Ø¨Ø¯Ù„ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      if (currentUserSearch) {
        // Ø¬Ø±Ù‘Ø¨ ÙƒØ³Ù„Ø³Ù„Ø©
        snapshot = await getDocs(query(
          collection(db, "users"),
          where("id", "==", currentUserSearch),
          limit(60)
        ));

        // Ù„Ùˆ id Ù…ØªØ®Ø²Ù† Ø±Ù‚Ù…ØŒ Ø¬Ø±Ù‘Ø¨ ÙƒØ±Ù‚Ù…
        if (snapshot.empty) {
          const n = Number(currentUserSearch);
          if (!Number.isNaN(n)) {
            snapshot = await getDocs(query(
              collection(db, "users"),
              where("id", "==", n),
              limit(60)
            ));
          }
        }

        usersList.innerHTML = '';
        if (btnMore) btnMore.style.display = 'none';
      } else {
        // âœ… Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ù…ÙŠØ¹ Pagination
        let q = query(collection(db, "users"), orderBy("createdAt", "desc"), limit(USERS_PAGE_SIZE));
        if (!reset && usersLastDoc) {
          q = query(collection(db, "users"), orderBy("createdAt", "desc"), startAfter(usersLastDoc), limit(USERS_PAGE_SIZE));
        }
        snapshot = await getDocs(q);

        if (reset) usersList.innerHTML = '';
        if (!snapshot.empty) usersLastDoc = snapshot.docs[snapshot.docs.length - 1];

        if (btnMore) {
          btnMore.style.display = snapshot.size < USERS_PAGE_SIZE ? 'none' : 'inline-flex';
        }
      }

      if (snapshot.empty) {
        usersList.innerHTML = `
          <div class="alert alert-info text-center rounded-3 py-4">
            ${currentUserSearch ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.'}
          </div>
        `;
        return;
      }

      const frag = document.createDocumentFragment();

      snapshot.forEach(d => {
        const user = d.data();
        const userId = d.id;

        const isSelf = auth.currentUser?.uid === userId;
        const isBanned = user.banned || false;
        const visitsCount = user.visitsCount || 0;

        const createdAt = user.createdAt?.toDate
          ? user.createdAt.toDate().toLocaleDateString('ar-EG')
          : (user.createdAt ? new Date(user.createdAt).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');

        const userDiv = document.createElement('div');
        userDiv.className = 'user-item mb-2';
        if (isBanned) {
          userDiv.style.opacity = '0.7';
          userDiv.style.border = '2px solid var(--admin-danger)';
        }

        const roleLabel = user.role === 'admin' ? 'Ø£Ø¯Ù…Ù†' : 'Ù…Ø³ØªØ®Ø¯Ù…';
        const roleBadge = user.role === 'admin' ? 'badge-admin' : 'badge-user';

        userDiv.innerHTML = `
          <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
            <div class="flex-grow-1">
              <h5 class="mb-1">
                ${user.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}
                <span class="badge ${roleBadge} ms-2">${roleLabel}</span>
                ${isBanned ? '<span class="badge badge-banned ms-2">Ù…Ø­Ø¸ÙˆØ±</span>' : ''}
                ${isSelf ? '<span class="badge bg-info ms-2">Ø£Ù†Øª</span>' : ''}
              </h5>

              <p class="mb-1 text-muted">${user.email || 'â€”'}</p>

              <div class="d-flex flex-wrap align-items-center gap-2">
                <span class="badge bg-primary">ID: ${user.id ?? 'â€”'}</span>
                <span class="text-muted small">
                  <i class="fas fa-calendar-plus me-1"></i> ØªÙ… Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${createdAt}
                </span>
                <span class="visits-count">
                  <i class="fas fa-eye me-1"></i> Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${visitsCount}
                </span>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-1 justify-content-md-end mt-2 mt-md-0">
              <button class="btn btn-admin btn-sm toggle-role-btn px-3" ${isSelf ? 'disabled' : ''}>
                ${user.role === 'admin' ? '<i class="fas fa-user-minus"></i> ØªÙ†Ø²ÙŠÙ„ Ù„Ù…Ø³ØªØ®Ø¯Ù…' : '<i class="fas fa-user-plus"></i> ØªØ±Ù‚ÙŠØ© Ù„Ø£Ø¯Ù…Ù†'}
              </button>

              <button class="btn ${isBanned ? 'btn-warning-sm' : 'btn-danger-sm'} btn-sm toggle-ban-btn px-3" ${isSelf ? 'disabled' : ''}>
                ${isBanned ? '<i class="fas fa-user-check"></i> ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : '<i class="fas fa-user-slash"></i> Ø­Ø¸Ø±'}
              </button>

              <button class="btn btn-danger-sm btn-sm delete-user-btn px-3" ${isSelf ? 'disabled' : ''}>
                <i class="fas fa-trash"></i> Ø­Ø°Ù
              </button>

              <button class="btn btn-view btn-sm px-3 perms-btn">
                <i class="fas fa-lock"></i> ØµÙ„Ø§Ø­ÙŠØ§Øª
              </button>
            </div>
          </div>
        `;

        const toggleRoleBtn = userDiv.querySelector('.toggle-role-btn');
        const toggleBanBtn  = userDiv.querySelector('.toggle-ban-btn');
        const deleteUserBtn = userDiv.querySelector('.delete-user-btn');
        const permsBtn      = userDiv.querySelector('.perms-btn');

        toggleRoleBtn?.addEventListener('click', () => toggleUserRole(userId, user.role));
        toggleBanBtn?.addEventListener('click', () => toggleUserBan(userId, isBanned));
        deleteUserBtn?.addEventListener('click', () => deleteUser(userId));
        permsBtn?.addEventListener('click', () => manageUserPermissions(userId));

        frag.appendChild(userDiv);
      });

      usersList.appendChild(frag);
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
      usersList.innerHTML = `
        <div class="alert alert-danger text-center rounded-3 py-3">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†: ${error.message}
        </div>
      `;
      if (btnMore) btnMore.style.display = 'none';
    } finally {
      usersLoading = false;
    }
  }

  // =========================
  // Ù…ÙˆØ§Ø¹ÙŠØ¯/ØªØ§Ø³ÙƒØ§Øª/Ù†ØªØ§Ø¦Ø¬ (ÙƒÙ…Ø§ Ù‡ÙŠ Ø¹Ù†Ø¯Ùƒ) â€” Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ÙˆØ¸ÙŠÙÙŠ
  // =========================
  function openAddAppointmentModal() {
    document.getElementById('appointmentId').value = '';
    document.getElementById('appointmentDay').value = '';
    document.getElementById('appointmentSubject').value = '';
    document.getElementById('appointmentDoctor').value = '';
    document.getElementById('appointmentLocation').value = '';
    document.getElementById('appointmentTime').value = '';
    document.getElementById('appointmentModalLabel').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¹Ø§Ù…';
    document.getElementById('saveAppointmentBtn').textContent = 'Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯';
    document.getElementById('saveAppointmentBtn').onclick = saveAppointment;
  }

  function openEditAppointmentModal(id, data) {
    document.getElementById('appointmentId').value = id;
    const parts = (data.title || '').split(' - ');
    document.getElementById('appointmentDay').value = parts[0] || '';
    document.getElementById('appointmentSubject').value = parts[1] || '';
    document.getElementById('appointmentDoctor').value = parts[2] || '';
    document.getElementById('appointmentLocation').value = parts[3] || '';
    document.getElementById('appointmentTime').value = data.time || '';
    document.getElementById('appointmentModalLabel').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯ Ø¹Ø§Ù…';
    document.getElementById('saveAppointmentBtn').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯';
    document.getElementById('saveAppointmentBtn').onclick = () => updateAppointment(id);
  }

  async function saveAppointment() {
    const day = document.getElementById('appointmentDay').value.trim();
    const subject = document.getElementById('appointmentSubject').value.trim();
    const doctor = document.getElementById('appointmentDoctor').value.trim();
    const location = document.getElementById('appointmentLocation').value.trim();
    const time = document.getElementById('appointmentTime').value;

    if (!day || !subject || !doctor || !location || !time) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!', 'danger');
      return;
    }

    const title = `${day} - ${subject} - ${doctor} - ${location}`;

    try {
      await addDoc(collection(db, "appointments"), {
        isGlobal: true,
        title,
        time,
        createdAt: new Date(),
        createdBy: auth.currentUser.uid
      });
      showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
      loadGlobalAppointments();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'danger');
    }
  }

  async function updateAppointment(id) {
    const day = document.getElementById('appointmentDay').value.trim();
    const subject = document.getElementById('appointmentSubject').value.trim();
    const doctor = document.getElementById('appointmentDoctor').value.trim();
    const location = document.getElementById('appointmentLocation').value.trim();
    const time = document.getElementById('appointmentTime').value;

    if (!day || !subject || !doctor || !location || !time) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!', 'danger');
      return;
    }

    const title = `${day} - ${subject} - ${doctor} - ${location}`;

    try {
      await updateDoc(doc(db, "appointments", id), { title, time, updatedAt: new Date() });
      showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
      loadGlobalAppointments();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message, 'danger');
    }
  }

  async function deleteGlobalAppointment(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø§Ù…ØŸ Ø³ÙŠØ®ØªÙÙŠ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!')) return;
    try {
      await deleteDoc(doc(db, "appointments", id));
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¹Ø§Ù…!', 'success');
      loadGlobalAppointments();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message, 'danger');
    }
  }

  function openAddTaskModal() {
    document.getElementById('taskId').value = '';
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskModalLabel').textContent = 'â• Ø¥Ø¶Ø§ÙØ© ØªØ§Ø³Ùƒ Ø¹Ø§Ù…';
    document.getElementById('saveTaskBtn').textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ§Ø³Ùƒ';
    document.getElementById('saveTaskBtn').onclick = saveTask;
  }

  function openEditTaskModal(id, data) {
    document.getElementById('taskId').value = id;
    document.getElementById('taskTitle').value = data.title;
    document.getElementById('taskModalLabel').textContent = 'âœï¸ ØªØ¹Ø¯ÙŠÙ„ ØªØ§Ø³Ùƒ Ø¹Ø§Ù…';
    document.getElementById('saveTaskBtn').textContent = 'ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø³Ùƒ';
    document.getElementById('saveTaskBtn').onclick = () => updateTask(id);
  }

  async function saveTask() {
    const title = document.getElementById('taskTitle').value.trim();
    if (!title) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„ØªØ§Ø³Ùƒ!', 'danger');
      return;
    }
    try {
      await addDoc(collection(db, "tasks"), {
        isGlobal: true,
        title,
        createdAt: new Date(),
        createdBy: auth.currentUser.uid
      });
      showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ø¹Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
      loadGlobalTasks();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'danger');
    }
  }

  async function updateTask(id) {
    const title = document.getElementById('taskTitle').value.trim();
    if (!title) {
      showNotification('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙˆØµÙ Ø§Ù„ØªØ§Ø³Ùƒ!', 'danger');
      return;
    }
    try {
      await updateDoc(doc(db, "tasks", id), { title, updatedAt: new Date() });
      showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø³Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('taskModal')).hide();
      loadGlobalTasks();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message, 'danger');
    }
  }

  async function deleteGlobalTask(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ø¹Ø§Ù…ØŸ Ø³ÙŠØ®ØªÙÙŠ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†!')) return;
    try {
      await deleteDoc(doc(db, "tasks", id));
      showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ§Ø³Ùƒ Ø§Ù„Ø¹Ø§Ù…!', 'success');
      loadGlobalTasks();
    } catch (error) {
      showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message, 'danger');
    }
  }

  async function loadGlobalAppointments() {
    const list = document.getElementById('globalAppointmentsList');
    list.innerHTML = '<div class="text-center"><div class="spinner-border text-warning"></div></div>';
    try {
      const q = query(collection(db, "appointments"), where("isGlobal", "==", true), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      list.innerHTML = '';
      if (snapshot.empty) {
        list.innerHTML = '<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¹Ø§Ù…Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
        return;
      }
      snapshot.forEach(d => {
        const appt = d.data();
        const docId = d.id;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5>${appt.title}</h5>
              <p class="text-warning"><i class="far fa-clock"></i> ${appt.time || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</p>
            </div>
            <div class="d-flex gap-1">
              <button class="btn btn-admin btn-sm edit-appt-btn"><i class="fas fa-edit"></i></button>
              <button class="btn btn-danger-sm btn-sm delete-appt-btn"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        list.appendChild(div);

        div.querySelector('.edit-appt-btn')?.addEventListener('click', () => openEditAppointmentModal(docId, appt));
        div.querySelector('.delete-appt-btn')?.addEventListener('click', () => deleteGlobalAppointment(docId));
      });
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯:", error);
      list.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${error.message}</div>`;
    }
  }

  async function loadGlobalTasks() {
    const list = document.getElementById('globalTasksList');
    list.innerHTML = '<div class="text-center"><div class="spinner-border text-warning"></div></div>';
    try {
      const q = query(collection(db, "tasks"), where("isGlobal", "==", true), orderBy("createdAt", "desc"));
      const snapshot = await getDocs(q);
      list.innerHTML = '';
      if (snapshot.empty) {
        list.innerHTML = '<div class="alert alert-info">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ§Ø³ÙƒØ§Øª Ø¹Ø§Ù…Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>';
        return;
      }
      snapshot.forEach(d => {
        const task = d.data();
        const docId = d.id;
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div><h5>${task.title}</h5></div>
            <div class="d-flex gap-1">
              <button class="btn btn-admin btn-sm edit-task-btn"><i class="fas fa-edit"></i></button>
              <button class="btn btn-danger-sm btn-sm delete-task-btn"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        list.appendChild(div);

        div.querySelector('.edit-task-btn')?.addEventListener('click', () => openEditTaskModal(docId, task));
        div.querySelector('.delete-task-btn')?.addEventListener('click', () => deleteGlobalTask(docId));
      });
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ§Ø³ÙƒØ§Øª:", error);
      list.innerHTML = `<div class="alert alert-danger">Ø®Ø·Ø£: ${error.message}</div>`;
    }
  }

  // =========================
  // Auth guard (Admin + banned)
  // =========================
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = 'index.html';
      return;
    }

    try {
      const userDocRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userDocRef);

      if (!userDoc.exists()) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        await signOut(auth);
        window.location.href = 'index.html';
        return;
      }

      const userData = userDoc.data();

      // âœ… Ù„Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø­Ø¸ÙˆØ±
      if (userData.banned === true) {
        await signOut(auth);
        alert("Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø­Ø¸ÙˆØ±. Ø§Ø±Ø¬Ø¹ Ù„Ù„Ù…Ø§Ù„Ùƒ/Ø§Ù„Ø£Ø¯Ù…Ù†.");
        window.location.href = 'index.html';
        return;
      }

      if (userData.role !== "admin") {
        alert("Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©!");
        window.location.href = 'index.html';
        return;
      }

      const now = new Date();

      if (!userData?.lastLogin) {
        await updateDoc(userDocRef, {
          lastLogin: now,
          visitsCount: (userData.visitsCount || 0) + 1
        });
        sendTelegramNotification('signup', user.email, user.uid);
      } else {
        await updateDoc(userDocRef, {
          lastLogin: now,
          visitsCount: (userData.visitsCount || 0) + 1
        });
        // Ù„Ùˆ ØªØ­Ø¨ Ø¥Ø´Ø¹Ø§Ø± Login: ÙØ¹Ù‘Ù„ Ø§Ù„Ø³Ø·Ø± Ø¯Ù‡
        // sendTelegramNotification('login', user.email, user.uid);
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      await loadUsers('', true);
      // Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ loadQuizResults() ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Ù…Ù„ÙÙƒØŒ Ù†Ø§Ø¯Ù Ø¹Ù„ÙŠÙ‡ Ù‡Ù†Ø§
      if (typeof loadQuizResults === 'function') loadQuizResults();
      loadGlobalAppointments();
      loadGlobalTasks();

      // Ø²Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
      const btnMore = ensureUsersLoadMoreButton();
      btnMore?.addEventListener('click', () => loadUsers('', false));
    } catch (e) {
      console.error(e);
      showNotification('Ø­ØµÙ„ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.', 'danger');
      await signOut(auth);
      window.location.href = 'index.html';
    }
  });

  // =========================
  // UI events
  // =========================
  document.getElementById('adminLogout')?.addEventListener('click', () => {
    signOut(auth).then(() => window.location.href = 'index.html');
  });

  document.querySelector('[data-bs-target="#appointmentModal"]')?.addEventListener('click', openAddAppointmentModal);
  document.querySelector('[data-bs-target="#taskModal"]')?.addEventListener('click', openAddTaskModal);

  // Ø¨Ø­Ø« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Exact)
  let searchTimer = null;
  document.getElementById('userSearch')?.addEventListener('keyup', (e) => {
    const v = (e.target.value || '').trim();
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => loadUsers(v, true), 250);
    document.getElementById('clearSearch').style.display = v ? 'block' : 'none';
  });

  document.getElementById('clearSearch')?.addEventListener('click', function() {
    const input = document.getElementById('userSearch');
    input.value = '';
    this.style.display = 'none';
    loadUsers('', true);
  });

  if (document.getElementById('clearSearch')) {
    document.getElementById('clearSearch').style.display = 'none';
  }
</script>
</body>
</html>
