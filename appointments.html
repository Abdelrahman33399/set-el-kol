<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <link rel="icon" href="Image_fx6.jpg" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ - Ø³Øª Ø§Ù„ÙƒÙ„</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* =========================
   THEME SYNC (Home -> Appointments)
   Ø§Ù„ØµÙ‚Ù‡ Ø¯Ø§Ø®Ù„ <style> ÙÙŠ ØµÙØ­Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ (ÙˆÙŠÙØ¶Ù‘Ù„ Ù…ÙƒØ§Ù† :root Ùˆ body)
   ========================= */

:root {
  /* Base */
  --bg-color: #121212;
  --text-light: #e0e0e0;

  /* Glass */
  --card-bg: rgba(255, 255, 255, 0.06);
  --border-color: rgba(255, 255, 255, 0.14);
  --glass-blur: 12px;

  /* Neon accents */
  --primary-neon: linear-gradient(45deg, #a453ff, #54aaff);
  --accent-orange: #ff6b35;
  --accent-orange-hover: #e05a2a;

  --shadow-purple: rgba(164, 83, 255, 0.45);
  --shadow-orange: rgba(255, 107, 53, 0.45);

  /* Extra */
  --neon-blue: #5d5fef;
  --soft-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
  --strong-shadow: 0 18px 55px rgba(0, 0, 0, 0.35);
}

/* Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ (Ù…ÙØ¹Ø¯Ù‘Ù„ Ù„ÙŠÙƒÙˆÙ† Ø£Ù‡Ø¯Ù‰ ÙˆØ£Ù‚Ù„ ÙˆÙ‡Ø¬) */
:root.day-mode {
  /* Off-white Ø¨Ø¯Ù„ Ø§Ù„Ø£Ø¨ÙŠØ¶ Ø§Ù„ØµØ±ÙŠØ­ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙˆÙ‡Ø¬ */
  --bg-color: #f6f4ee;

  /* Ù†ØµÙˆØµ ØºØ§Ù…Ù‚Ø© ÙˆÙˆØ§Ø¶Ø­Ø© */
  --text-light: #111827;

  /* Glass Ù‡Ø§Ø¯ÙŠ */
  --card-bg: rgba(255, 255, 255, 0.62);
  --border-color: rgba(17, 24, 39, 0.10);

  /* Ù†ÙŠÙˆÙ† Ù†Ù‡Ø§Ø±ÙŠ Ù„ÙƒÙ† Ù…Ø´ Ù…Ø¨Ù‡Ø± */
  --primary-neon: linear-gradient(45deg, #2f3bff, #ff6b35);

  /* Accent */
  --accent-orange: #e65c00;
  --accent-orange-hover: #cc5200;

  /* Shadows Ø£Ø®Ù */
  --shadow-purple: rgba(47, 59, 255, 0.18);
  --shadow-orange: rgba(230, 92, 0, 0.22);

  /* (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ­ÙƒÙ… Ø£Ø¯Ù‚ ÙÙŠ Ø§Ù„Ø¸Ù„Ø§Ù„ Ø¨Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ */
  --soft-shadow: 0 12px 30px rgba(17, 24, 39, 0.12);
  --strong-shadow: 0 18px 45px rgba(17, 24, 39, 0.18);
}

/* Body + Ø®Ù„ÙÙŠØ© Ø¹Ø§Ù…Ø© */
body {
  background:
    radial-gradient(1100px 600px at 85% 12%, rgba(93, 95, 239, 0.18), transparent 55%),
    radial-gradient(900px 520px at 10% 30%, rgba(255, 107, 53, 0.16), transparent 55%),
    linear-gradient(180deg, rgba(7,9,22,1), rgba(5,6,20,1));
  background-color: var(--bg-color);
  color: var(--text-light);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  overflow-x: hidden;
  position: relative;
  min-height: 100vh;
}

/* Day mode: Ø®Ù„ÙÙŠØ© Ù†Ù‡Ø§Ø±ÙŠØ© Ø£Ù‡Ø¯Ù‰ + Ø£Ù‚Ù„ Ø³Ø·ÙˆØ¹ */
:root.day-mode body {
  background:
    radial-gradient(1100px 600px at 85% 12%, rgba(47, 59, 255, 0.07), transparent 58%),
    radial-gradient(900px 520px at 10% 30%, rgba(38, 105, 239, 0.07), transparent 58%),
    linear-gradient(180deg, #d6a40f, #1267efba);
}

/* Blobs Ø®Ù„ÙÙŠØ© (Ø®ÙÙŠÙØ©) */
body::before,
body::after {
  content: "";
  position: fixed;
  width: 520px;
  height: 520px;
  border-radius: 50%;
  filter: blur(45px);
  opacity: 0.55;
  z-index: 0;
  pointer-events: none;
}

body::before {
  top: -160px;
  right: -180px;
  background:
    radial-gradient(circle at 30% 30%, rgba(93,95,239,.75), transparent 60%),
    radial-gradient(circle at 70% 60%, rgba(255,107,53,.55), transparent 62%);
  animation: blobMove1 10s ease-in-out infinite;
}

body::after {
  bottom: -210px;
  left: -210px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,107,53,.65), transparent 60%),
    radial-gradient(circle at 70% 60%, rgba(93,95,239,.45), transparent 62%);
  animation: blobMove2 12s ease-in-out infinite;
}

@keyframes blobMove1 {
  0%,100% { transform: translate(0,0) scale(1); }
  50% { transform: translate(-18px, 22px) scale(1.05); }
}
@keyframes blobMove2 {
  0%,100% { transform: translate(0,0) scale(1); }
  50% { transform: translate(22px, -18px) scale(1.06); }
}

/* Ø®Ù„ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙÙˆÙ‚ Ø§Ù„Ù€ blobs */
.container, .chat-bot, .admin-section, .global-appointment-card, table, .theme-toggle-btn {
  position: relative;
  z-index: 1;
}

        .neon-title {
            background: var(--primary-neon);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            font-weight: 800;
            text-shadow: 0 0 10px var(--shadow-purple);
            margin-bottom: 2rem;
        }
        .chat-bot {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .bot-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
        }
        .bot-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-orange);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .bot-bubble {
            background: rgba(255, 107, 53, 0.2);
            padding: 1rem;
            border-radius: 15px;
            margin: 0.5rem 0;
            color: var(--text-light);
            border-right: 3px solid var(--accent-orange);
        }
        .user-input {
            display: flex;
            gap: 10px;
            margin-top: 1rem;
        }
        .user-input input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--border-color);
            color: var(--text-light);
            padding: 10px 15px;
            border-radius: 12px;
        }
        .action-btns {
            display: flex;
            gap: 10px;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        .action-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }
        .add-btn { background: var(--accent-orange); color: white; }
        .add-btn:hover { background: var(--accent-orange-hover); }
        .clear-btn { background: #6c757d; color: white; }
        .clear-btn:hover { background: #5a6268; }
        .edit-btn { background: #ffc107; color: black; }
        .edit-btn:hover { background: #e0a800; }
        .admin-section {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 3rem;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        .admin-badge {
            background: var(--accent-orange);
            color: white;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .back-to-home-btn {
            position: initial;
            bottom: 20px;
            left: 20px;
            z-index: 1000;
            background: var(--accent-orange);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            box-shadow: 0 4px 15px var(--shadow-orange);
            transition: all 0.3s ease;
        }
        .back-to-home-btn:hover {
            background: var(--accent-orange-hover);
            box-shadow: 0 8px 20px var(--shadow-orange);
            transform: scale(1.05);
        }
        .theme-toggle-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--accent-orange);
            color: white;
            border: none;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px var(--shadow-orange);
            transition: all 0.3s ease;
        }
        .theme-toggle-btn:hover {
            background: var(--accent-orange-hover);
            transform: translateY(-3px) rotate(15deg);
        }
        .global-appointments-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .global-appointment-card {
            background: rgba(255, 255, 255, 0.04);
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 14px;
            position: relative;
            transition: all 0.3s ease;
            cursor: default;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .global-appointment-card:hover {
            transform: translateY(-3px) scale(1.005);
            box-shadow: 0 8px 24px var(--shadow-orange);
            border-color: var(--accent-orange);
            background: rgba(255, 107, 53, 0.09);
        }
        .global-appointment-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            color: var(--text-light);
        }
        .global-appointment-card .card-body {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
            gap: 10px;
            font-size: 0.95rem;
        }
        .global-appointment-card .card-item {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            border-left: 3px solid var(--accent-orange);
            transition: all 0.2s ease;
        }
        .global-appointment-card .card-item:hover {
            background: rgba(255, 107, 53, 0.12);
            transform: scale(1.02);
        }
        .global-appointment-card .card-item-label {
            font-size: 0.75rem;
            opacity: 0.75;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .global-appointment-card .card-item-value {
            font-weight: bold;
            word-break: break-word;
            line-height: 1.3;
        }
        .empty-message {
            text-align: center;
            color: var(--text-light);
            opacity: 0.6;
            padding: 1.5rem;
            font-style: italic;
            border: 1px dashed var(--border-color);
            border-radius: 12px;
        }
        @media (max-width: 768px) {
            .neon-title {
                font-size: 2rem;
            }
            .global-appointment-card .card-body {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* =========================
           UPDATE: Dynamic FX (icons + reveal) - My Appointments
           ========================= */
        .chat-bot,
        .admin-section,
        .global-appointment-card,
        #addFormContainer .card {
          position: relative;
          overflow: hidden;
        }

        /* Floating icons layer */
        .fx-icons{
          position:absolute;
          inset:0;
          z-index:0;
          pointer-events:none;
          opacity:.9;
        }
        .fx-icons .fx-icon{
          position:absolute;
          color: rgba(255, 107, 53, 0.22);
          filter: drop-shadow(0 10px 20px rgba(0,0,0,.25));
          transform: translate3d(0,0,0);
          animation: fxFloat 6.6s ease-in-out infinite;
        }
        .fx-icons .i1{ top: 14%; right: 8%; font-size: 22px; animation-duration: 7.2s; }
        .fx-icons .i2{ bottom: 12%; left: 10%; font-size: 26px; animation-duration: 8s; opacity:.75; }
        .fx-icons .i3{ top: 52%; left: 58%; font-size: 18px; animation-duration: 6.2s; opacity:.55; }

        @keyframes fxFloat{
          0%,100%{ transform: translateY(0) rotate(0deg); opacity:.65; }
          50%{ transform: translateY(-10px) rotate(10deg); opacity:1; }
        }

        /* Content above icons */
        .chat-bot > *,
        .admin-section > *,
        .global-appointment-card > *,
        #addFormContainer .card > *{
          position: relative;
          z-index: 1;
        }

        /* Reveal animation */
        .reveal{
          opacity: 0;
          transform: translateY(14px);
          transition: opacity .65s ease, transform .65s ease;
          will-change: transform, opacity;
        }
        .reveal.show{
          opacity: 1;
          transform: translateY(0);
        }

        @media (prefers-reduced-motion: reduce){
          .fx-icons .fx-icon{ animation: none !important; }
          .reveal{ opacity: 1; transform: none; transition: none; }
        }
    </style>
</head>
<body>
    <button id="themeToggle" class="theme-toggle-btn">
        <i class="fas fa-moon"></i>
    </button>

    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="image-modal-content" id="fullSizeImage">
        <div id="modalCaption" class="modal-caption"></div>
    </div>

    <div class="container py-5">
        <h1 class="neon-title text-center mb-4"> Ù…ÙˆØ§Ø¹ÙŠØ¯ÙŠ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h1>

        <div class="row justify-content-center">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="chat-bot">
                    <div class="bot-header">
                        <div class="bot-avatar">ğŸ¤–</div>
                        <h5>Ø¨ÙˆØª Ø³Øª Ø§Ù„ÙƒÙ„ Ø§Ù„Ø°ÙƒÙŠ</h5>
                    </div>
                    <div class="bot-bubble" id="welcomeBubble">
                        ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§! Ø£Ù†Ø§ Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ø£Ø³Ø§Ø¹Ø¯Ùƒ ØªÙ†Ø¸Ù… Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©. Ù‚ÙˆÙ„ Ù„ÙŠ: "Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯" Ø£Ùˆ "Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„" Ø£Ùˆ "Ø§Ù…Ø³Ø­ ÙƒÙ„ Ø­Ø§Ø¬Ø©".
                    </div>
                    <div id="chatMessages"></div>

                    <div class="user-input">
                        <input type="text" id="userCommand" placeholder="Ø§ÙƒØªØ¨ Ø£Ù…Ø±Ùƒ Ù‡Ù†Ø§..." class="form-control" onkeypress="if(event.key==='Enter') processCommand()">
                        <button class="btn add-btn" onclick="processCommand()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mt-4">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="action-btns">
                    <button class="action-btn add-btn" onclick="showAddForm()">
                        <i class="fas fa-plus-circle me-1"></i> Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ ÙŠØ¯ÙˆÙŠ
                    </button>
                    <button class="action-btn clear-btn" onclick="clearAllAppointments()">
                        <i class="fas fa-trash-alt me-1"></i> Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                    </button>
                    <a href="index.html" class="back-to-home-btn">
                        <i class="fas fa-arrow-left me-2"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </a>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mt-4" id="addFormContainer" style="display:none;">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="card bg-dark text-light p-4">
                    <h4><i class="fas fa-calendar-plus me-2"></i> Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h4>
                    <form id="addAppointment">
                        <div class="mb-3">
                            <input type="text" class="form-control bg-secondary text-light" id="appointmentTitle" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…ÙˆØ¹Ø¯" required>
                        </div>
                        <div class="mb-3">
                            <input type="datetime-local" class="form-control bg-secondary text-light" id="appointmentTime" required>
                        </div>
                        <button type="submit" class="btn w-100 add-btn">
                            <i class="fas fa-save me-2"></i> Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mt-4">
            <div class="col-12 col-md-10 col-lg-8">
                <h3 class="text-light mb-3">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ</h3>
                <div class="table-responsive">
                    <table class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th><i class="fas fa-check-circle"></i></th>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="appointmentsTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row justify-content-center mt-5">
            <div class="col-12 col-md-10 col-lg-8">
                <div class="admin-section">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <span class="admin-badge">Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†</span>
                        <h4 class="mb-0 text-light">ğŸ“Œ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ù„Ø³ÙƒØ§Ø´Ù† (Ø£Ø³Ø§Ø³ÙŠØ©)</h4>
                    </div>
                    <div id="globalAppointmentsContainer" class="global-appointments-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // --- Firebase Setup (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            collection,
            query,
            where,
            getDocs,
            addDoc,
            updateDoc,
            deleteDoc,
            doc,
            orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDeapYypO595vcDWUoh1gOncsGkQ5EZdyE",
            authDomain: "sit-el-kol.firebaseapp.com",
            projectId: "sit-el-kol",
            storageBucket: "sit-el-kol.firebasestorage.app",
            messagingSenderId: "573924344198",
            appId: "1:573924344198:web:fec2e9a54c1c152cd16c07",
            measurementId: "G-CWVJDKPS0M"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let allAppointments = [];

        // --- DOM Elements ---
        const appointmentsTable = document.getElementById('appointmentsTable');
        const globalAppointmentsContainer = document.getElementById('globalAppointmentsContainer');
        const addFormContainer = document.getElementById('addFormContainer');

        // --- Setup after DOM loaded (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        document.addEventListener('DOMContentLoaded', function () {
            setupThemeToggle();
        });

        // --- Authentication Guard (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadAppointments();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- Load Appointments (Personal + Global) (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        async function loadAppointments() {
            try {
                const personalQ = query(
                    collection(db, "appointments"),
                    where("userId", "==", currentUser.uid),
                    orderBy("time", "asc")
                );

                const globalQ = query(
                    collection(db, "appointments"),
                    where("isGlobal", "==", true),
                    orderBy("createdAt", "desc")
                );

                const [personalSnap, globalSnap] = await Promise.all([
                    getDocs(personalQ),
                    getDocs(globalQ)
                ]);

                allAppointments = [];

                personalSnap.forEach(doc => {
                    if (doc.data().isGlobal !== true) {
                        allAppointments.push({ id: doc.id, ...doc.data(), type: 'personal' });
                    }
                });

                globalSnap.forEach(doc => {
                    allAppointments.push({ id: doc.id, ...doc.data(), type: 'global' });
                });

                renderAppointments();
                renderGlobalAppointments();

            } catch (error) {
                console.error("Error loading appointments:", error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: ' + error.message, 'danger');
            }
        }

        // --- Render Personal Appointments (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        function renderAppointments() {
            appointmentsTable.innerHTML = '';
            const personalApps = allAppointments.filter(a => a.type === 'personal');

            if (personalApps.length === 0) {
                appointmentsTable.innerHTML = `
                    <tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¨Ø¹Ø¯.</td></tr>
                `;
                return;
            }

            personalApps.forEach(app => {
                let timeFormatted = "";

                if (app.time) {
                    if (app.time.toDate) {
                        const dateTime = app.time.toDate();
                        if (!isNaN(dateTime.getTime())) {
                            timeFormatted = dateTime.toLocaleString('ar-EG', {
                                weekday: 'short',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    } else if (typeof app.time === 'string') {
                        const dateTime = new Date(app.time);
                        if (!isNaN(dateTime.getTime())) {
                            timeFormatted = dateTime.toLocaleString('ar-EG', {
                                weekday: 'short',
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                }

                appointmentsTable.innerHTML += `
                    <tr>
                        <td>
                            <input type="checkbox" class="form-check-input" ${app.completed ? 'checked' : ''}
                                   onchange="toggleCompleted('${app.id}', this.checked)">
                        </td>
                        <td>${timeFormatted}</td>
                        <td class="${app.completed ? 'text-decoration-line-through text-muted' : ''}">
                          ${app.title} ${app.completed ? '<span class="badge bg-success ms-2">ØªÙ… âœ”</span>' : ''}
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editAppointment('${app.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteAppointment('${app.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        // --- Render Global Appointments as Cards (ÙƒÙ…Ø§ Ù‡ÙŠ) ---
        function renderGlobalAppointments() {
            globalAppointmentsContainer.innerHTML = '';

            const globalApps = allAppointments.filter(a => a.type === 'global');
            if (globalApps.length === 0) {
                globalAppointmentsContainer.innerHTML = `
                    <div class="empty-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¹Ø§Ù…Ø© Ù…Ø¶Ø§ÙØ© Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
                `;
                return;
            }

            globalApps.forEach(app => {
                const card = document.createElement('div');
                card.className = 'global-appointment-card';

                let timeFormatted = app.time || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                if (timeFormatted !== "ØºÙŠØ± Ù…Ø­Ø¯Ø¯") {
                    try {
                        const [hours, minutes] = timeFormatted.split(':');
                        const hoursInt = parseInt(hours);

                        const ampm = hoursInt >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ù‹Ø§';
                        const displayHours = hoursInt % 12 || 12;

                        timeFormatted = `${displayHours}:${minutes} ${ampm}`;
                    } catch (e) { }
                }

                let day = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                let subject = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                let doctor = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                let location = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

                if (app.title && app.title.includes('-')) {
                    const parts = app.title.split('-').map(p => p.trim());
                    day = parts[0] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    subject = parts[1] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    doctor = parts[2] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                    location = parts[3] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                } else {
                    subject = app.title || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
                }

                card.innerHTML = `
                    <div class="card-header">
                        <span>ğŸ“… ${day}</span>
                        <span class="badge bg-info">Ø¹Ø§Ù…/Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù†</span>
                    </div>
                    <div class="card-body">
                        <div class="card-item">
                            <div class="card-item-label">Ø§Ù„ÙˆÙ‚Øª</div>
                            <div class="card-item-value">${timeFormatted}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-item-label">Ø§Ù„Ù…ÙƒØ§Ù†</div>
                            <div class="card-item-value">${location}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-item-label">Ø§Ù„Ø¯ÙƒØªÙˆØ±/Ø§Ù„Ù…ÙØ¹ÙŠØ¯</div>
                            <div class="card-item-value">${doctor}</div>
                        </div>
                        <div class="card-item">
                            <div class="card-item-label">Ø§Ù„Ù…Ø§Ø¯Ø©</div>
                            <div class="card-item-value">${subject}</div>
                        </div>
                    </div>
                `;

                globalAppointmentsContainer.appendChild(card);
            });
        }

        async function saveAppointment(title, time) {
            try {
                await addDoc(collection(db, "appointments"), {
                    userId: currentUser.uid,
                    title: title,
                    time: time,
                    completed: false,
                    isGlobal: false,
                    createdAt: new Date()
                });
                showNotification('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
                await loadAppointments();
            } catch (error) {
                console.error("Error saving appointment:", error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: ' + error.message, 'danger');
            }
        }

        async function toggleCompleted(id, completed) {
            try {
                await updateDoc(doc(db, "appointments", id), { completed });
                await loadAppointments();
                showNotification(completed ? 'ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©! âœ”' : 'ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡Ø§.');
            } catch (error) {
                console.error("Error updating:", error);
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'danger');
            }
        }

        async function editAppointment(id) {
            const app = allAppointments.find(a => a.id === id && a.type === 'personal');
            if (!app) return;

            const newTitle = prompt('Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:', app.title);
            if (newTitle === null) return;

            const newTime = prompt('Ø¹Ø¯Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª (YYYY-MM-DDTHH:MM):', app.time);
            if (newTime === null) return;

            try {
                await updateDoc(doc(db, "appointments", id), {
                    title: newTitle,
                    time: newTime
                });
                showNotification('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„!');
                await loadAppointments();
            } catch (error) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ' + error.message, 'danger');
            }
        }

        async function deleteAppointment(id) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø®Ø§ØµØŸ')) return;
            try {
                await deleteDoc(doc(db, "appointments", id));
                showNotification('ØªÙ… Ø§Ù„Ø­Ø°Ù!');
                await loadAppointments();
            } catch (error) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù: ' + error.message, 'danger');
            }
        }

        async function clearAllAppointments() {
            if (!confirm('Ù…Ø³Ø­ ÙƒÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø®Ø§ØµØ©ØŸ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¹Ø§Ù…Ø© Ù…Ø´ Ù‡ØªØªØ£Ø«Ø±.')) return;
            try {
                const q = query(
                    collection(db, "appointments"),
                    where("userId", "==", currentUser.uid),
                    where("isGlobal", "!=", true)
                );
                const snap = await getDocs(q);

                const batch = [];
                snap.forEach(docu => batch.push(deleteDoc(docu.ref)));
                await Promise.all(batch);

                showNotification('ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø®Ø§ØµØ©!');
                await loadAppointments();
            } catch (error) {
                showNotification('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ' + error.message, 'danger');
            }
        }

        function showAddForm() {
            addFormContainer.style.display = 'block';
            document.getElementById('addAppointment').onsubmit = async (e) => {
                e.preventDefault();
                const title = document.getElementById('appointmentTitle').value.trim();
                const time = document.getElementById('appointmentTime').value;
                if (!title || !time) {
                    showNotification('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª!', 'warning');
                    return;
                }
                await saveAppointment(title, time);
                resetAddForm();
            };
        }

        function resetAddForm() {
            document.getElementById('addAppointment').reset();
            addFormContainer.style.display = 'none';
        }

        function processCommand() {
            const cmd = document.getElementById('userCommand').value.trim().toLowerCase();
            document.getElementById('userCommand').value = '';
            if (!cmd) return;

            if (cmd.includes('Ø£Ø¶Ù Ù…ÙˆØ¹Ø¯') || cmd.includes('add appointment')) {
                showAddForm();
                return;
            } else if (cmd.includes('Ù…Ø³Ø­ ÙƒÙ„') || cmd.includes('clear all')) {
                clearAllAppointments();
                return;
            }

            showNotification('Ø¬Ø±Ø¨: "Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯" Ø£Ùˆ "Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„"');
        }

        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const root = document.documentElement;

            if (localStorage.getItem('theme') === 'day') {
                root.classList.add('day-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }

            themeToggle.addEventListener('click', function() {
                if (root.classList.contains('day-mode')) {
                    root.classList.remove('day-mode');
                    localStorage.setItem('theme', 'night');
                    themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    root.classList.add('day-mode');
                    localStorage.setItem('theme', 'day');
                    themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
                }
            });
        }

        function showNotification(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `alert alert-${type} position-fixed bottom-0 end-0 m-3`;
            div.style.zIndex = 9999;
            div.innerHTML = `<i class="fas fa-bell me-2"></i>${msg}`;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        window.processCommand = processCommand;
        window.showAddForm = showAddForm;
        window.clearAllAppointments = clearAllAppointments;
        window.toggleCompleted = toggleCompleted;
        window.editAppointment = editAppointment;
        window.deleteAppointment = deleteAppointment;
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Targets for floating icons
      const fxTargets = document.querySelectorAll('.chat-bot, .admin-section, .global-appointment-card, #addFormContainer .card');
      fxTargets.forEach(el => {
        if (el.querySelector('.fx-icons')) return;
        const icons = document.createElement('div');
        icons.className = 'fx-icons';
        icons.setAttribute('aria-hidden', 'true');
        icons.innerHTML = `
          <i class="fas fa-calendar-check fx-icon i1" aria-hidden="true"></i>
          <i class="fas fa-clock fx-icon i2" aria-hidden="true"></i>
          <i class="fas fa-circle fx-icon i3" aria-hidden="true"></i>
        `;
        el.appendChild(icons);
      });

      // Reveal on scroll (IntersectionObserver)
      const revealTargets = document.querySelectorAll('.chat-bot, .action-btns, #addFormContainer, .table-responsive, .admin-section, .global-appointment-card');
      revealTargets.forEach(el => el.classList.add('reveal'));

      const io = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting){
            entry.target.classList.add('show');
            io.unobserve(entry.target);
          }
        });
      }, { threshold: 0.12 });

      revealTargets.forEach(el => io.observe(el));
    });
    </script>

</body>
</html>
